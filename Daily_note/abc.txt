from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait, Select
from selenium.webdriver.support import expected_conditions as EC
import time

# ğŸ“Œ 1. ë¸Œë¼ìš°ì € ì„¤ì •
options = Options()
#options.add_argument("--headless")  # ì°½ ë„ìš°ì§€ ì•ŠìŒ (ê°œë°œ ì¤‘ì´ë¼ë©´ ì£¼ì„ ì²˜ë¦¬í•´ë„ ë¨)
#options.add_argument("--window-size=1920,1080")
driver = webdriver.Chrome(options=options)

# ğŸ“Œ 2. ì‚¬ì´íŠ¸ ì ‘ì†
driver.get("https://tmacs.kotsa.or.kr/web/TG/TG300/TG3100/Tg2127.jsp?mid=S1810")
WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.ID, "sido")))

# ğŸ“Œ 3. 'ì„œìš¸' ì„ íƒ
Select(driver.find_element(By.ID, "sido")).select_by_visible_text("ì„œìš¸")
time.sleep(2)

# ğŸ“Œ 4. 'ê°•ë‚¨êµ¬' ì„ íƒ
Select(driver.find_element(By.ID, "jijace")).select_by_visible_text("ê°•ë‚¨êµ¬")
time.sleep(2)

# ğŸ“Œ 5. ì¡°íšŒ ë²„íŠ¼ í´ë¦­
driver.find_element(By.XPATH, "//a[contains(@class, 'btn_primary')]").click()
time.sleep(3)  # ë°ì´í„° ë¡œë”© ì‹œê°„

# ğŸ“Œ 6. ê²°ê³¼ ê·¸ë¦¬ë“œ ì…€ div ëª¨ë‘ ê°€ì ¸ì˜¤ê¸°
divs = WebDriverWait(driver, 10).until(
    EC.presence_of_all_elements_located((By.CSS_SELECTOR, "#rMateH5__Content69 > div"))
)

print(f"âœ… {len(divs)}ê°œì˜ ì…€ div ê°ì§€ë¨")

# ğŸ“Œ 7. í•˜ë‚˜ì”© ì…€ í´ë¦­ â†’ íŒì—… ì—´ê¸° â†’ 3ì´ˆ í›„ ë‹«ê¸°
main_window = driver.current_window_handle

for idx, div in enumerate(divs):
    try:
        print(f"\nâ–¶ {idx+1}/{len(divs)}ë²ˆì§¸ ì…€ í´ë¦­ ì‹œë„ ì¤‘...")

        # ìŠ¤í¬ë¡¤í•´ì„œ ë³´ì´ê²Œ í•˜ê³  í´ë¦­
        driver.execute_script("arguments[0].scrollIntoView(true);", div)
        time.sleep(0.3)
        driver.execute_script("arguments[0].click();", div)

        # ìƒˆ ì°½ ì—´ë¦´ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
        WebDriverWait(driver, 10).until(lambda d: len(d.window_handles) > 1)

        # ìƒˆ ì°½ í•¸ë“¤ë¡œ ì „í™˜
        for handle in driver.window_handles:
            if handle != main_window:
                popup_window = handle
                break
        driver.switch_to.window(popup_window)

        # íŒì—… ë‚´ìš© ëŒ€ê¸° ë° ì¼ë¶€ ì¶œë ¥
        WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.TAG_NAME, "body")))
        print(f"âœ… íŒì—… ì—´ë¦¼: {driver.title}")
        time.sleep(3)  # ğŸ“Œ 3ì´ˆ ìœ ì§€

        # íŒì—… ë‹«ê¸°
        driver.close()
        driver.switch_to.window(main_window)

    except Exception as e:
        print(f"âŒ {idx+1}ë²ˆ ì…€ì—ì„œ ì˜¤ë¥˜ ë°œìƒ: {e}")
        driver.switch_to.window(main_window)
        continue

print("\nğŸ‰ ëª¨ë“  ì…€ í´ë¦­ ë° íŒì—… ì²˜ë¦¬ ì™„ë£Œ!")
driver.quit()
